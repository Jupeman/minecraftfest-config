#!/usr/bin/env bash
set -euo pipefail

GROUP="paper"
DEFAULT_VERSION="1.21.11"
USER_AGENT="msm-paper-update/1.0.0 (https://github.com/Jupeman/minecraftfest-config)"

VERSION="${1:-$DEFAULT_VERSION}"
DIR="/opt/msm/jars/${GROUP}"

echo "==> Paper update for version: ${VERSION}"

echo "==> Checking latest Paper build for ${VERSION}..."
BUILD_JSON="$(
  curl -fsSL -H "User-Agent: ${USER_AGENT}" \
    "https://fill.papermc.io/v3/projects/paper/versions/${VERSION}/builds/latest"
)"

LATEST_BUILD="$(echo "${BUILD_JSON}" | python3 -c 'import sys,json; d=json.loads(sys.stdin.read(), strict=False); print(d["id"])')"
JAR_NAME="$(echo "${BUILD_JSON}" | python3 -c 'import sys,json; d=json.loads(sys.stdin.read(), strict=False); print(d["downloads"]["server:default"]["name"])')"
DOWNLOAD_URL="$(echo "${BUILD_JSON}" | python3 -c 'import sys,json; d=json.loads(sys.stdin.read(), strict=False); print(d["downloads"]["server:default"]["url"])')"

echo "==> Latest build: ${LATEST_BUILD}"
echo "==> Download URL: ${DOWNLOAD_URL}"

echo "==> Updating MSM jargroup URL..."
msm jargroup changeurl "${GROUP}" "${DOWNLOAD_URL}"

echo "==> Downloading via MSM..."
msm jargroup getlatest "${GROUP}"

echo "==> Pointing paper-current.jar to newest jar in ${DIR}..."
cd "${DIR}"
LATEST_FILE="$(ls -1t *paper-${VERSION}-*.jar 2>/dev/null | head -n 1 || true)"
if [[ -z "${LATEST_FILE}" ]]; then
  echo "ERROR: No paper jar found in ${DIR}"
  exit 1
fi

ln -sf "${LATEST_FILE}" paper-current.jar
echo "paper-current.jar -> ${LATEST_FILE}"

echo "==> Done. Restart manually when ready:"
echo "   msm <server> restart now"
echo "   msm restart now   # restarts all active servers"
